<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë„ˆêµ¬ë¦¬ì˜ ì£¼ë¨¹ì§ˆ â€” í’€ìˆ² ì „ì„¤í¸ (ì™„ì „ ë¦¬ë¹Œë“œ)</title>
<style>
:root{
  --ink:#eef6f0; --leaf:#1d3c2a; --leaf2:#2c5a3f; --leaf3:#0f2419; --accent:#7ed9a7;
  --warn:#ffd479; --bad:#ff6161; --good:#66ffa1; --panel:#0e1d15; --rope:#35644a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:
 radial-gradient(160% 120% at 50% -10%, #214a33 0%, #13281e 40%, #0b1a13 70%, #08140e 100%);
 color:var(--ink);font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Pretendard,Arial}

/* ====== HUD & Header ====== */
header{position:fixed;inset:0 0 auto 0;height:56px;display:flex;align-items:center;gap:12px;
  padding:10px 14px;background:#0b1510cc;border-bottom:1px solid #203a2b;backdrop-filter:blur(6px);z-index:50}
header b{font-weight:900;letter-spacing:.3px}
.hud{opacity:.9;font-size:12px}
.stack{display:flex;align-items:center;gap:10px;margin-left:auto}
.bar{width:190px;height:12px;background:#183224;border-radius:6px;overflow:hidden;border:1px solid #0e2218}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,#54e18f,#8af);width:100%;transition:width .18s}
.bar.enemy>i{background:linear-gradient(90deg,#ff8383,#e33)}
.bar.st>i{background:linear-gradient(90deg,#89ffb3,#b9f)}
.coins{display:flex;align-items:center;gap:6px;margin-left:14px}
.coins i{width:14px;height:14px;border-radius:50%;background:radial-gradient(#ffd86b,#c9a43a);box-shadow:0 0 6px #0007}

/* ====== Stage ====== */
main{position:fixed;inset:56px 0 170px 0;display:grid;place-items:center}
.ring{position:relative;width:min(980px,94vw);aspect-ratio:16/9;background:
 radial-gradient(90% 70% at 50% 100%, #0d2016 0 65%, transparent 66%) , #0f2219;
 border:1px solid #1a3426;box-shadow:0 30px 80px #000a inset,0 10px 40px #000a;overflow:hidden}
.ropes{position:absolute;inset:auto 0 14% 0;height:28%;background:
 linear-gradient(var(--rope) 0 0) 0% 0%/100% 2px no-repeat,
 linear-gradient(var(--rope) 0 0) 0% 50%/100% 2px no-repeat,
 linear-gradient(var(--rope) 0 0) 0% 100%/100% 2px no-repeat;opacity:.55}
.leaves{position:absolute;inset:0;pointer-events:none;opacity:.35}
.leaves i{position:absolute;width:8px;height:14px;border-radius:2px 8px 2px 8px;background:#62a87a}
@keyframes drift{0%{transform:translateY(-10vh) rotate(0)}100%{transform:translateY(90vh) rotate(180deg)}}

/* ====== Enemy & Effects ====== */
.enemyArea{position:absolute;left:50%;top:54%;transform:translate(-50%,-50%);filter:drop-shadow(0 26px 30px #000a)}
.enemyArea.hit{animation:hit .15s}
.enemyArea.red{filter:hue-rotate(-10deg) saturate(1.2) drop-shadow(0 0 26px #ff4444)}
@keyframes hit{0%{transform:translate(-50%,-50%) scale(0.96)}50%{transform:translate(-52%,-48%) scale(1.05)}100%{transform:translate(-50%,-50%) scale(1)}}
.nameTag{position:absolute;left:50%;top:-34px;transform:translateX(-50%);font-weight:900;text-shadow:0 2px 8px #000}
.tele{position:absolute;left:50%;top:-60px;transform:translateX(-50%);color:var(--warn);opacity:0;transition:opacity .1s;font-weight:800}
.faceWrap{position:relative;width:min(44vmin,440px);aspect-ratio:1/1.02;border-radius:18px;overflow:hidden;border:1px solid #203a2b;background:#0d1f16}
.faceWrap img{display:block;width:100%;height:100%;object-fit:cover}
.faceWrap canvas.fx{position:absolute;inset:0;pointer-events:none}
.clone{position:absolute;top:54%;transform:translate(-50%,-50%) scale(.96);opacity:.8;filter:contrast(1.1) saturate(1.05)}
.smoke{position:absolute;inset:0;pointer-events:none}

/* ====== Aim ====== */
.aim{position:absolute;left:50%;bottom:8%;transform:translate(-50%,0);width:0;height:0;pointer-events:none}
.aim::before{content:"";position:absolute;left:var(--x,0px);bottom:0;width:2px;height:86px;background:linear-gradient(#fff,#7ed9a7);box-shadow:0 0 8px #7ed9a7aa}
.aimDot{position:absolute;left:calc(var(--x,0px) - 8px);bottom:82px;width:16px;height:16px;border:2px solid #7ed9a7;border-radius:50%;box-shadow:0 0 10px #7ed9a7cc}
.aimDot.lock{border-color:#ff9e7e;box-shadow:0 0 14px #ff9e7e}

/* ====== Hands ====== */
.hands{position:fixed;inset:auto 0 0 0;height:140px;display:flex;justify-content:space-between;padding:0 6vw 12px 6vw;pointer-events:none}
.fist{width:140px;height:112px;border-radius:24px;background-image:url('6.png');background-size:contain;background-repeat:no-repeat;background-position:center;
 box-shadow:0 10px 20px #000a;transform-origin:50% 90%;transition:transform .06s,filter .06s}
.fist.left{transform:translate(-8px,14px) rotate(6deg)}
.fist.right{transform:translate(8px,14px) rotate(-6deg) scaleX(-1)}
.fist.left.punch{transform:translate(-8px,14px) translateY(-36px) rotate(6deg) scale(1.12) !important;filter:brightness(1.3) drop-shadow(0 0 12px rgba(255,200,100,0.8))}
.fist.right.punch{transform:translate(8px,14px) translateY(-36px) rotate(-6deg) scale(-1.12,1.12) !important;filter:brightness(1.3) drop-shadow(0 0 12px rgba(255,200,100,0.8))}
.fist.left.block{filter:brightness(1.05);transform:translate(-8px,14px) translateY(-10px) rotate(6deg) scale(1.02)}
.fist.right.block{filter:brightness(1.05);transform:translate(8px,14px) translateY(-10px) rotate(-6deg) scale(-1.02,1.02)}

/* ====== Modal & Story ====== */
.center{position:fixed;inset:0;display:grid;place-items:center;z-index:60}
.modal{max-width:min(900px,92vw);pointer-events:auto;background:#0b1510e6;border:1px solid #1b3426;border-radius:16px;padding:18px;box-shadow:0 30px 90px #000c}
.modal h1{margin:0 0 8px;font-size:22px}
.modal p{margin:8px 0;opacity:.9}
.modal .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{background:var(--accent);color:#082015;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.secondary{background:#1f3428;color:#cfeee0}
.storyBox{position:fixed;left:50%;top:54px;transform:translateX(-50%);width:min(980px,94vw);background:#0b1510e6;border:1px solid #203a2b;border-radius:14px;padding:14px;z-index:55;display:none}
.storyBox h2{margin:0 0 8px;font-size:18px}
.storyText{white-space:pre-wrap;line-height:1.5}
.choices{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.choice{background:#183224;border:1px solid #29503a;color:#dff; padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:800}

/* ====== Skills ====== */
.skills{position:fixed;right:10px;bottom:176px;display:grid;gap:8px;z-index:45}
.skill{display:flex;align-items:center;gap:8px;background:#0f1f17;border:1px solid #1b3426;border-radius:10px;padding:6px 8px;min-width:220px}
.skill b{min-width:130px}
.cd{height:8px;background:#15271f;border-radius:6px;overflow:hidden;flex:1}
.cd>i{display:block;height:100%;background:linear-gradient(90deg,#79b,#6af);width:0%}

/* ====== Touch ====== */
.touch{position:fixed;inset:auto 0 0 0;height:120px;display:flex;gap:8px;align-items:stretch;justify-content:center;padding:8px;z-index:44}
.touch button{flex:1;min-width:0;border:1px solid #2a4c38;border-radius:10px;background:#102219;color:#e9f2ff;font-weight:900}
@media (min-width:980px){.touch{display:none}}

/* ====== FX ====== */
@keyframes shake{0%,100%{transform:translate(0) rotate(0)}25%{transform:translate(-4px,2px) rotate(-1deg)}50%{transform:translate(4px,-2px) rotate(1deg)}75%{transform:translate(-2px,1px) rotate(-0.5deg)}}
.shake{animation:shake .12s 1}
.combo{position:fixed;left:50%;bottom:26px;transform:translateX(-50%);font-weight:900;color:#ffd86b;text-shadow:0 0 10px #000;z-index:60}
.combo.hide{display:none}
</style>
</head>
<body tabindex="0">
<header>
  <div><b id="title">ë„ˆêµ¬ë¦¬ì˜ ì£¼ë¨¹ì§ˆ</b> â€” <span id="stageTxt">1/5</span> : <span id="enemyName">ìƒì¥</span></div>
  <div class="stack">
    <span class="hud">HP</span><div class="bar"><i id="hp"></i></div>
    <span class="hud">STA</span><div class="bar st"><i id="st"></i></div>
    <span class="hud">ENEMY</span><div class="bar enemy"><i id="ehp"></i></div>
    <div class="coins"><i></i><span id="coinTxt">0</span></div>
  </div>
</header>

<main>
  <div class="ring" id="ring">
    <div class="leaves" id="leaves"></div>
    <div class="ropes"></div>

    <div class="enemyArea" id="enemyWrap">
      <div class="nameTag" id="nameTag">ìƒì¥</div>
      <div class="tele" id="tele">!</div>
      <div class="faceWrap">
        <!-- ìŠ¤í…Œì´ì§€ë³„ ì–¼êµ´ ì´ë¯¸ì§€: 1.png ~ 5.png (ë™ì¼ í´ë”) -->
        <img id="face" src="1.png" alt="enemy">
        <canvas class="fx" id="fx" width="440" height="440"></canvas>
      </div>
    </div>

    <!-- ì—ì„ í‘œì‹œ -->
    <div class="aim" id="aim"><i class="aimDot" id="aimDot"></i></div>

    <!-- ë¶„ì‹  ìŠ¤ëª¨í¬ ë ˆì´ì–´ -->
    <canvas class="smoke" id="smoke" width="1600" height="900"></canvas>
  </div>
</main>

<!-- ìŠ¤í† ë¦¬ ë°•ìŠ¤ -->
<div class="storyBox" id="storyBox">
  <h2 id="storyTitle">í’€ìˆ²ì˜ ì‹œì‘</h2>
  <div class="storyText" id="storyText"></div>
  <div class="choices" id="choices"></div>
</div>

<div class="hands">
  <div class="fist left" id="left"></div>
  <div class="fist right" id="right"></div>
</div>

<div class="skills">
  <div class="skill"><b>Q ë„ˆêµ´í€ì¹˜</b><div class="cd"><i id="cdQ"></i></div></div>
  <div class="skill"><b>E ë°•ì¹˜ê¸°</b><div class="cd"><i id="cdE"></i></div></div>
  <div class="skill"><b>R í•˜ìš¸ë§ ê°€ë“œ</b><div class="cd"><i id="cdR"></i></div></div>
  <div class="skill"><b>T ë™ë£Œ ì†Œí™˜</b><div class="cd"><i id="cdT"></i></div></div>
</div>

<div class="center" id="center">
  <div class="modal" id="modal">
    <h1>ë„ˆêµ¬ë¦¬ì˜ ì£¼ë¨¹ì§ˆ â€” í’€ìˆ² ì „ì„¤í¸</h1>
    <p>ë¹„ ë‚´ë¦¬ëŠ” í’€ìˆ², ì•¼ìƒì˜ ë³µì‹±. 5ëª…ì˜ ìƒëŒ€ë¥¼ ë„˜ì–´ ì „ì„¤ì´ ë˜ì–´ë¼.</p>
    <p class="hud">ì¡°ì‘: A/D=í€ì¹˜, S/Space=ê°€ë“œ, â‡§+â†/â†’=ë‹·ì§€, â†/â†’=ì—ì„, Q/E/R/T=ìŠ¤í‚¬, Enter=ì‹œì‘Â·ë‹¤ìŒ, P=ì¼ì‹œì •ì§€</p>
    <div class="btns"><button class="btn" id="startBtn">ì‹œì‘</button><button class="btn secondary" id="howBtn">ì¡°ì‘ë²•</button></div>
  </div>
</div>

<div class="touch">
  <button id="btnAimL">ì—ì„â—€</button>
  <button id="btnL">ì™¼ì£¼ë¨¹</button>
  <button id="btnBlk">ê°€ë“œ</button>
  <button id="btnR">ì˜¤ë¥¸ì£¼ë¨¹</button>
  <button id="btnAimR">ì—ì„â–¶</button>
  <button id="btnQ">Q</button>
  <button id="btnE">E</button>
  <button id="btnRk">R</button>
  <button id="btnT">T</button>
</div>

<div class="combo hide" id="comboTxt">COMBO x1</div>

<div class="toast" id="toast" style="position:fixed;left:50%;top:66px;transform:translateX(-50%);background:#0b1510d0;border:1px solid #274a38;padding:8px 12px;border-radius:8px;display:none;font-weight:800;z-index:70"></div>

<script>
(()=>{
// ===== ë°°ê²½ ì íŒŒí‹°í´ =====
const leaves=document.getElementById('leaves');
for(let i=0;i<28;i++){
  const el=document.createElement('i');
  el.style.left=Math.random()*100+'%';
  el.style.animation=`drift ${8+Math.random()*8}s linear ${Math.random()*8}s infinite`;
  el.style.background = Math.random()<.33?'#6fb78d':(Math.random()<.66?'#4f9a73':'#82caa6');
  leaves.appendChild(el);
}

// ===== ìº”ë²„ìŠ¤ & ê¸°ë³¸ ìš”ì†Œ =====
const $ring=document.getElementById('ring');
const $hp=document.getElementById('hp'), $st=document.getElementById('st'), $ehp=document.getElementById('ehp');
const $stageTxt=document.getElementById('stageTxt'), $enemyName=document.getElementById('enemyName');
const $wrap=document.getElementById('enemyWrap'), $tele=document.getElementById('tele'), $name=document.getElementById('nameTag');
const $faceImg=document.getElementById('face');
const left=document.getElementById('left'), right=document.getElementById('right');
const $toast=document.getElementById('toast'), $center=document.getElementById('center'), $modal=document.getElementById('modal');
const cdQ=document.getElementById('cdQ'), cdE=document.getElementById('cdE'), cdR=document.getElementById('cdR'), cdT=document.getElementById('cdT');
const storyBox=document.getElementById('storyBox'), storyTitle=document.getElementById('storyTitle'), storyText=document.getElementById('storyText'), choicesBox=document.getElementById('choices');
const fx=document.getElementById('fx').getContext('2d');
const aim=document.getElementById('aim'), aimDot=document.getElementById('aimDot');
const smoke=document.getElementById('smoke'); const sfx=smoke.getContext('2d');
const comboTxt=document.getElementById('comboTxt'); const coinTxt=document.getElementById('coinTxt');

// ===== ìŠ¤í…Œì´ì§€ ë°ì´í„° (ì´ë¯¸ì§€ ê²½ë¡œ: ë™ì¼ í´ë” 1.png~5.png) =====
const STAGES=[
  {name:"ìƒì¥ â€˜ì¹˜ì¦ˆë³´ì´â€™", hp:90, atk:9,  freq:1400, tele:240, img:"1.png", desc:"í’€ ê°€ì¥ìë¦¬ì˜ ë‚ ìŒ˜ ë³µì„œ", speed:0.68, skills:['tp']},
  {name:"í† ë¼ â€˜ì í”„ì§±â€™",   hp:110, atk:11, freq:1250, tele:220, img:"2.png", desc:"ì í”„ í›…ì˜ ë‹¬ì¸", speed:0.86, skills:['clone','hopkick']},
  {name:"ì‚¬ìŠ´ â€˜ì€ë¹›ë¿”â€™",   hp:145, atk:13, freq:1150, tele:210, img:"3.png", desc:"í˜¸ìˆ˜ì˜ ìˆ˜í˜¸ì", speed:0.98, skills:['tp','clone','shield']},
  {name:"í˜¸ë‘ì´ â€˜ë²ˆê°œì¤„ë¬´ëŠ¬â€™",hp:190, atk:19, freq:980,  tele:200, img:"4.png", desc:"ë§¹ìˆ˜ì˜ ì½¤ë³´", speed:1.12, skills:['tp','clone','doubleclaw']},
  {name:"ì¡°í­ ì•„ë©”ë¦¬ì¹´ë¼ì¿¤ â€˜ëˆë¼ì¿¤â€™", hp:240, atk:23, freq:900,  tele:190, img:"5.png", desc:"ìµœí›„ì˜ ì ", speed:1.28, skills:['tp','clone','smoke']}
];

// ===== ìŠ¤í† ë¦¬ ë…¸ë“œ =====
const Story = {
  'intro': { title:'í’€ìˆ²ì˜ ì‹œì‘', text:`í’€ì ìœ„ ë¹„ ëƒ„ìƒˆ. ì˜¤ë˜ëœ ê¸€ëŸ¬ë¸Œê°€ ì†ì— ë§ë¬¼ë¦°ë‹¤.\nâ€œì˜¤ëŠ˜ì€â€¦ ìš´ëª…ì˜ ë‚ ì´ì•¼.â€\n\në¬´ì—‡ë¶€í„° í• ê¹Œ?`,
    choices:[
      {label:'[ì¥ë¹„ ì ê²€] ë°©ì–´ ìŠµê´€ì„ ë˜ìƒˆê¸´ë‹¤ (ê°€ë“œ íš¨ìœ¨â†‘)', effect:()=>{ State.guardBoost=0.6; toast('ë°©ì–´ íš¨ìœ¨ í–¥ìƒ'); }, next:'s1_pre'},
      {label:'[í•˜ëŠ˜ ì˜¬ë ¤ë‹¤ë³´ê¸°] ë§ˆìŒì„ ê°€ë‹¤ë“¬ëŠ”ë‹¤ (ì²« ìŠ¤í‚¬ ê°€ì†)', effect:()=>{ State.firstSkillFast=true; toast('ì²« ìŠ¤í‚¬ ì¿¨ -30%'); }, next:'s1_pre'}
    ]},
  's1_pre':{ title:'1. ìƒì¥ â€˜ì¹˜ì¦ˆë³´ì´â€™', text:`í’€ ê°€ì¥ìë¦¬, ì‘ì€ ê·¸ë¦¼ìê°€ íˆ­ íŠ€ì–´ë‚˜ì˜¨ë‹¤.\nâ€œì¹˜ì¦ˆëŠ” í›Œë¥­í•œ ë‹¨ë°±ì§ˆì´ì•¼!â€`,
    choices:[
      {label:'[ë†ë‹´ ë˜ì§€ê¸°] â€œì¹˜ì¦ˆ? ë‚œ ëœì¥íŒŒì•¼.â€ (ì  íšŒí”¼â†“)', effect:()=>{ State.enemyEvasion=0.0; }, next:'fight'},
      {label:'[ì¡°ìš©íˆ ì‘ì‹œ] ì§‘ì¤‘ë„ë¥¼ ë†’ì¸ë‹¤ (ê³µê²©ë ¥ +5%)', effect:()=>{ State.atkBonus+=5; }, next:'fight'}
    ], beforeFight:true },
  's2_pre':{ title:'2. í† ë¼ â€˜ì í”„ì§±â€™', text:`í™íŠ€ëŠ” ë°œë†€ë¦¼. ê·€ê°€ ë°”ëŒì„ ê°€ë¥¸ë‹¤.`,
    choices:[
      {label:'[ìƒì²˜ë¥¼ ê±±ì •í•œë‹¤] ì „íˆ¬ í›„ íšŒë³µ +10', effect:()=>{ State.onClearHeal=10; }, next:'fight'},
      {label:'[ë„ë°œí•œë‹¤] ë³´ìƒâ†‘/ê³µê²©ë¹ˆë„â†‘', effect:()=>{ State.enemyFreqScale=0.9; State.reward+=10; }, next:'fight'}
    ], beforeFight:true },
  's3_pre':{ title:'3. ì‚¬ìŠ´ â€˜ì€ë¹›ë¿”â€™', text:`í˜¸ìˆ˜ ìœ„ ì•ˆê°œ. â€œì‹¸ì›€ì˜ ëì€ ë¬´ì—‡ì¸ê°€.â€`,
    choices:[
      {label:'[ëŒ€í™”] í•˜ìš¸ë§ ê°€ë“œ ê°•í™”', effect:()=>{ State.guardEmpower=true; }, next:'fight'},
      {label:'[ì¹¨ë¬µ] í˜ìœ¼ë¡œ ì„¤ë“í•œë‹¤', effect:()=>{}, next:'fight'}
    ], beforeFight:true },
  's4_pre':{ title:'4. í˜¸ë‘ì´ â€˜ë²ˆê°œì¤„ë¬´ëŠ¬â€™', text:`ì˜› ìŠ¤ìŠ¹ì˜ ëˆˆë¹›. ë²ˆê°œê°€ ëˆˆë™ìì— ìŠ¤ì¹œë‹¤.`,
    choices:[
      {label:'[ìŠ¤ìŠ¹ë‹˜â€¦] ì‹œì‘ 8ì´ˆ ë¬´ì ', effect:()=>{ State.startGrace=8000; }, next:'fight'},
      {label:'[ë³µìˆ˜ ì„ ì–¸] ë¶„ë…¸ ì½¤ë³´ (í€ì¹˜ ë°ë¯¸ì§€ ì ì¦)', effect:()=>{ State.rageCombo=true; }, next:'fight'}
    ], beforeFight:true },
  's5_pre':{ title:'5. ì¡°í­ ì•„ë©”ë¦¬ì¹´ë¼ì¿¤ â€˜ëˆë¼ì¿¤â€™', text:`í’€ í‹ˆ ì‚¬ì´, ê¸ˆë¹› ì²´ì¸ì˜ ì†Œë¦¬. â€œëˆì´ëƒ ì£¼ë¨¹ì´ëƒ.â€`,
    choices:[
      {label:'[íƒ€í˜‘] íšŒí”¼ ë£¨íŠ¸ (ì—”ë”©1)', effect:()=>{ State.altEnding='truce'; }, next:'fight'},
      {label:'[ì •ë©´ ëŒ€ê²°] (ì—”ë”©2)', effect:()=>{ State.altEnding=null; }, next:'fight'},
      {label:'[â€œì´ê±´ ë³µìˆ˜ê°€ ì•„ë‹ˆì•¼.â€] (ì—”ë”©3 ì „ì„¤)', effect:()=>{ State.legendFlag=true; }, next:'fight'}
    ], beforeFight:true }
};

// ===== ì „ì—­ ìƒíƒœ =====
let stage=0, enemyHp=STAGES[0].hp, playerHp=100, stamina=100;
let paused=true, stunned=false, blocking=false;
let enemyLoop=null, lastDodge=0, teleShownAt=0, allyTimer=null, rage=0;
let enemyX=0.5, enemyDir=1; // 0~1 ìœ„ì¹˜
let aimX=0.5; // 0~1 ìœ„ì¹˜ (ë ˆì´ì €)
let clones=[]; // {x,el,real:boolean}
let moveTimer=null, skillTimer=null;
let canPunch=true, punchCD=220, lastPunchAt=0; // í€ì¹˜ ì¿¨íƒ€ì„
let hitstop=0, combo=0, comboTimer=0; // íˆíŠ¸ìŠ¤í†±/ì½¤ë³´
let coins=0, noDamageStreak=0; // ë¦¬ì›Œë“œ/ë‚œì´ë„ ìŠ¤ì¼€ì¼ë§
let guardChain=0, guardBroken=false; // ê°€ë“œë¸Œë ˆì´í¬
let healCapUsed=false; // ìŠ¤í…Œì´ì§€ íšŒë³µ ìƒí•œ ê´€ë¦¬

// ===== ìŠ¤í† ë¦¬/ë²„í”„ =====
const State={
  guardBoost:0.5,
  firstSkillFast:false,
  onClearHeal:0,
  enemyEvasion:0.05,
  enemyFreqScale:1.0,
  reward:0,
  guardEmpower:false,
  startGrace:0,
  rageCombo:false,
  legendFlag:false,
  altEnding:null,
  atkBonus:0
};

// ===== ìœ í‹¸ =====
function bar(el,v){ el.style.width=Math.max(0,Math.min(100,v))+'%'; }
function refreshBars(){ bar($hp,playerHp); bar($st,stamina); const maxE=STAGES[stage].hp; bar($ehp,100*enemyHp/maxE); coinTxt.textContent = coins; }
function toast(msg,ms=900){ $toast.textContent=msg; $toast.style.display='block'; clearTimeout($toast._t); $toast._t=setTimeout(()=> $toast.style.display='none', ms); }
function flash(color='#ffffff18', ms=100){ fx.clearRect(0,0,440,440); fx.fillStyle=color; fx.fillRect(0,0,440,440); setTimeout(()=>fx.clearRect(0,0,440,440),ms); }
function spark(intensity=10){ fx.strokeStyle='rgba(255,230,160,.95)'; fx.lineWidth=4; for(let i=0;i<intensity;i++){ fx.beginPath(); const x=220+Math.random()*80-40, y=220+Math.random()*80-40; fx.moveTo(x,y); fx.lineTo(x+(Math.random()*60-30), y+(Math.random()*60-30)); fx.stroke(); } setTimeout(()=> fx.clearRect(0,0,440,440), 120); }
function shake(){ $ring.classList.add('shake'); setTimeout(()=> $ring.classList.remove('shake'), 120); }
function setStage(i){ stage=i; enemyHp=STAGES[i].hp; enemyX=0.5; enemyDir=1; clearClones(); $stageTxt.textContent=`${i+1}/5`; $enemyName.textContent=STAGES[i].name; $name.textContent=STAGES[i].name; $faceImg.src=STAGES[i].img; $wrap.className='enemyArea'; $tele.style.opacity=0; placeEnemy(); }
function placeEnemy(){ const ringRect=$ring.getBoundingClientRect(); const x=ringRect.width*enemyX; $wrap.style.left = x + 'px'; $wrap.style.transform='translate(-50%,-50%)'; }
function placeAim(){ const ringRect=$ring.getBoundingClientRect(); const x=ringRect.width*aimX - ringRect.width/2; aim.style.setProperty('--x', x+ 'px'); }

// ===== íˆíŠ¸ìŠ¤í†± ë£¨í”„ =====
let rafId=null; function loop(){ if(hitstop>0){ hitstop--; rafId = requestAnimationFrame(loop); return; } rafId = requestAnimationFrame(loop); }
rafId = requestAnimationFrame(loop);

// ===== ìŠ¤í† ë¦¬ í‘œì‹œ =====
function showStory(id){ const node=Story[id]; storyTitle.textContent=node.title; storyText.textContent=node.text; choicesBox.innerHTML=''; node.choices.forEach(ch=>{ const b=document.createElement('button'); b.className='choice'; b.textContent=ch.label; b.onclick=()=>{ ch.effect&&ch.effect(); storyBox.style.display='none'; if(node.beforeFight){ startFight(); } else { showStory(ch.next); } }; choicesBox.appendChild(b); }); storyBox.style.display='block'; document.body.focus(); }

// ===== ë‚œì´ë„ ìŠ¤ì¼€ì¼ë§ =====
function applyDifficultyScaling(onClear){ if(onClear && playerHp>=90) { noDamageStreak++; } else if(!onClear) { noDamageStreak=0; }
  const scale = 1 + Math.min(0.25, noDamageStreak*0.08); // ìµœëŒ€ +25%
  State.enemyFreqScale = 1/scale; // ë¹ˆë„ ë¹¨ë¼ì§
}

// ===== ì  ì´ë™ & íŒ¨í„´ =====
function startMovement(){ clearInterval(moveTimer); const speed=STAGES[stage].speed; const dt=16; moveTimer=setInterval(()=>{ if(paused||stunned) return; enemyX += enemyDir*speed*dt/10000; if(enemyX<0.08){enemyX=0.08; enemyDir=1;} if(enemyX>0.92){enemyX=0.92; enemyDir=-1;} placeEnemy(); }, dt); }
function enemyPattern(){ clearInterval(enemyLoop); clearInterval(skillTimer); const s=STAGES[stage]; enemyLoop=setInterval(()=>{ if(paused||stunned) return; telegraphAndAttack(); }, Math.max(360, s.freq*State.enemyFreqScale)); skillTimer=setInterval(()=>{ if(paused) return; const pick=(s.skills[Math.floor(Math.random()*s.skills.length)]); if(pick==='tp') enemyTeleport(); else if(pick==='clone') enemyClones(); else if(pick==='hopkick') enemyHopKick(); else if(pick==='shield') enemyShield(); else if(pick==='doubleclaw') enemyDoubleClaw(); else if(pick==='smoke') enemySmoke(); }, 5000 - stage*380); }
function telegraphAndAttack(){ $tele.style.opacity=1; $wrap.classList.add('red'); teleShownAt=Date.now(); const s=STAGES[stage]; setTimeout(()=>{ $tele.style.opacity=0; $wrap.classList.remove('red'); resolveEnemyAttack(); }, s.tele); }
function resolveEnemyAttack(){ const s=STAGES[stage]; if(State.startGrace>0){ const now=Date.now(); if(!resolveEnemyAttack._startAt) resolveEnemyAttack._startAt=now; if(now - resolveEnemyAttack._startAt < State.startGrace){ toast('ì‹œì‘ ë¬´ì '); return; } }
  let dmg=s.atk; if(blocking){ dmg=Math.floor(dmg*State.guardBoost); stamina=Math.max(0, stamina-8); guardChain++; if(guardChain>=3 && !guardBroken){ // ê°€ë“œ ë¸Œë ˆì´í¬
      guardBroken=true; dmg += 4; stamina=Math.max(0, stamina-30); toast('ê°€ë“œ ë¸Œë ˆì´í¬!'); flash('#ff336644',160); setTimeout(()=>{guardBroken=false; guardChain=0;}, 1200); }
  } else { guardChain=0; }
  if(Date.now()-lastDodge<260) dmg=0; if(dmg===0){ toast('íšŒí”¼!'); spark(6); return; }
  playerHp=Math.max(0, playerHp-dmg); flash('#ff000033'); shake(); refreshBars(); if(playerHp<=0) return gameOver(false); }

// ===== ì  ìŠ¤í‚¬ êµ¬í˜„ =====
function enemyTeleport(){ const old=enemyX; flash('#88e0ff33'); setTimeout(()=>{ enemyX = 0.1 + Math.random()*0.8; enemyDir = (enemyX>old)?1:-1; placeEnemy(); flash('#88e0ffaa',120); toast('ìˆœê°„ì´ë™!'); }, 100); }
function clearClones(){ clones.forEach(c=>c.el.remove()); clones=[]; }
function enemyClones(){ if(clones.length) return; const count=2 + (stage>2?1:0); const realIndex=Math.floor(Math.random()*(count+1)); const frag=document.createDocumentFragment(); const ringRect=$ring.getBoundingClientRect(); const xs=[]; for(let i=0;i<count+1;i++){ xs.push(0.1+Math.random()*0.8); } xs[realIndex]=enemyX; xs.forEach((x,i)=>{ const el=document.createElement('div'); el.className='clone'; el.style.left = (ringRect.width*x) + 'px'; el.style.filter='drop-shadow(0 16px 20px #000a)'; el.innerHTML = document.querySelector('.faceWrap').outerHTML; frag.appendChild(el); clones.push({x,el,real:(i===realIndex)}); }); $ring.appendChild(frag); toast('ë¶„ì‹ ìˆ ! ì§„ì§œë¥¼ ì°¾ì•„ë¼',1000); setTimeout(()=>{ clearClones(); }, 6000 - stage*300); }
function enemyHopKick(){ // í† ë¼: ì—°ì† ì í”„ í›„ í›„ë°© í‚¥ (ë‹·ì§€ í•„ìˆ˜)
  toast('ì í”„ ì—°ì†!'); setTimeout(()=>{ if(Date.now()-lastDodge>280){ playerHp=Math.max(0, playerHp-8); flash('#ff775533',120); refreshBars(); }}, 240);
}
function enemyShield(){ // ì‚¬ìŠ´: ìŠ¤í‚¬ ë¬´íš¨í™” ë²„í”„
  toast('ìˆ²ì˜ ë°©íŒ¨! ì›ê±°ë¦¬/ìŠ¤í‚¬ ë¬´íš¨'); State.skillBlocked=true; setTimeout(()=>{ State.skillBlocked=false; }, 2500);
}
function enemyDoubleClaw(){ // í˜¸ë‘ì´: ì—°ì† 2íƒ€
  toast('ë”ë¸” í´ë¡œ!'); setTimeout(()=> resolveEnemyAttack(), 120); setTimeout(()=> resolveEnemyAttack(), 420);
}
function enemySmoke(){ // ë³´ìŠ¤: ì—°ë§‰ + ìœ„ì¹˜ ìŠ¤ì™‘
  toast('ì—°ë§‰íƒ„! ì‹œì•¼ ì œí•œ'); smokeBurst(); setTimeout(()=> enemyTeleport(), 220);
}
function smokeBurst(){ const rect=$ring.getBoundingClientRect(); sfx.clearRect(0,0,smoke.width,smoke.height); const cx=rect.width*enemyX, cy=rect.height*0.54; let r=10; const id=setInterval(()=>{ sfx.fillStyle='rgba(180,180,180,0.12)'; sfx.beginPath(); sfx.arc(cx, cy, r, 0, Math.PI*2); sfx.fill(); r+=20; if(r>260){ clearInterval(id); setTimeout(()=>sfx.clearRect(0,0,smoke.width,smoke.height), 400); } }, 16); }

function isRealTargetHit(){ const ringRect=$ring.getBoundingClientRect(); const pxAim=ringRect.width*aimX; const tol = 52; // íŒì •(px)
  // ì˜¤í† ì—ì„ í‘œì‹œ
  const dxReal = Math.abs(pxAim - ringRect.width*enemyX);
  aimDot.classList.toggle('lock', dxReal<tol*0.6);
  if(clones.length){ let hitAny=false, hitReal=false; let closestFake=null, minDist=1e9; clones.forEach(c=>{ const dx=Math.abs(pxAim - ringRect.width*c.x); if(dx<tol){ hitAny=true; if(c.real) hitReal=true; else if(dx<minDist){minDist=dx; closestFake=c;} } }); if(hitAny && !hitReal){ playerHp=Math.max(0, playerHp-6); refreshBars(); flash('#ff557733',120); toast('ë¶„ì‹ ì˜ ì—­ìŠµ! -6'); } return hitReal; }
  return dxReal<tol;
}

// ===== í€ì¹˜/ìŠ¤í‚¬ =====
function showCombo(){ if(combo<=1){ comboTxt.classList.add('hide'); return; } comboTxt.textContent = `COMBO x${combo}`; comboTxt.classList.remove('hide'); clearTimeout(showCombo._t); showCombo._t=setTimeout(()=> comboTxt.classList.add('hide'), 700); }
function doPunch(side){ if(paused||stamina<=0) return; const now=Date.now(); if(now-lastPunchAt<punchCD){ return; } lastPunchAt=now; const fist=(side==='L')?left:right; fist.classList.add('punch'); setTimeout(()=> fist.classList.remove('punch'), 90); stamina=Math.max(0, stamina-7); let base=9 + (State.atkBonus||0), varc=4, dmg=Math.floor(base+Math.random()*varc); const dt=Date.now()-teleShownAt; let counter=false; if (dt>=0 && dt<=160) { dmg=Math.floor(dmg*1.6); counter=true; }
  if(State.rageCombo){ rage++; dmg += Math.floor(rage/4); }
  const hit=isRealTargetHit(); shake(); if(hit){ enemyHp=Math.max(0, enemyHp-dmg); flash('#ffffff44',100); spark(10); hitstop=6; combo++; comboTimer=60; showCombo(); if(counter){ doStun(STAGES[stage].tele+320); toast('ì¹´ìš´í„°! -'+dmg); } else { toast('íˆíŠ¸ -'+dmg); } } else { flash('#ffffff11',90); combo=0; toast('ë¹—ë§ìŒ'); }
  if(enemyHp<=0) return winStage(); refreshBars(); }
function doStun(ms){ if(stunned) return; stunned=true; $wrap.classList.add('red'); setTimeout(()=>{stunned=false;$wrap.classList.remove('red')}, ms); }
function block(on){ blocking=on; left.classList.toggle('block', on); right.classList.toggle('block', on); }

// ìŠ¤íƒœë¯¸ë‚˜ íšŒë³µ
setInterval(()=>{ if(paused) return; stamina=Math.min(100, stamina+(blocking?1.4:2.6)); if(comboTimer>0){ comboTimer--; if(comboTimer===0) combo=0; } refreshBars(); }, 250);

// ì¿¨íƒ€ì„ ë°”
const cd={Q:0,E:0,R:0,T:0}, cdMax={Q:6300,E:7200,R:10000,T:12000};
function tickCd(){ for(const k of ['Q','E','R','T']) if(cd[k]>0) cd[k]=Math.max(0,cd[k]-100); cdBar(cdQ,cd.Q,cdMax.Q); cdBar(cdE,cd.E,cdMax.E); cdBar(cdR,cd.R,cdMax.R); cdBar(cdT,cd.T,cdMax.T); }
function cdBar(el,cur,max){ el.style.width=(100*(1-cur/max))+'%'; }
setInterval(tickCd,100);

function skillQ(){ if(paused||cd.Q>0) return toast('ì¿¨íƒ€ì„â€¦'); if(State.skillBlocked){ toast('ìŠ¤í‚¬ ë´‰ì¸ ì¤‘!'); return; } cd.Q=State.firstSkillFast?Math.floor(cdMax.Q*0.7):cdMax.Q; State.firstSkillFast=false; toast('ë„ˆêµ´í€ì¹˜!', 600); flash('#7ed9a744',160); let hits=0; doStun(320); const comboInt=setInterval(()=>{ if(hits>=3 || enemyHp<=0 || paused){ clearInterval(comboInt); return; } const side=(hits%2?'R':'L'); lastPunchAt=0; doPunch(side); hits++; },110); }
function skillE(){ if(paused||cd.E>0) return toast('ì¿¨íƒ€ì„â€¦'); if(State.skillBlocked){ toast('ìŠ¤í‚¬ ë´‰ì¸ ì¤‘!'); return; } cd.E=cdMax.E; flash('#ffefaa66',120); setTimeout(()=> flash('#ff8800aa',100), 50); const hit=isRealTargetHit(); let dmg = 24 + Math.floor(Math.random()*7); if(hit){ enemyHp=Math.max(0, enemyHp-dmg); refreshBars(); toast('ë°•ì¹˜ê¸°!! -'+dmg, 800); doStun(500);} else { toast('ë°•ì¹˜ê¸° ë¹—ë§ìŒ'); stamina=Math.max(0, stamina-8); }
  if(enemyHp<=0) winStage(); }
function skillR(){ if(paused||cd.R>0) return toast('ì¿¨íƒ€ì„â€¦'); cd.R=cdMax.R; block(true); const dur=State.guardEmpower?3000:2000; toast('í•˜ìš¸ë§! ë¬´ì  '+(dur/1000)+'ì´ˆ', 1000); flash('#8fffb055',140); let t=0; const reg=setInterval(()=>{ if(t>dur){clearInterval(reg);return;} stamina=Math.min(100, stamina+(State.guardEmpower?4:2)); refreshBars(); t+=200; },200); setTimeout(()=>{ block(false); fx.clearRect(0,0,440,440); },dur); }
function skillT(){ if(paused||cd.T>0) return toast('ì¿¨íƒ€ì„â€¦'); if(State.skillBlocked){ toast('ìŠ¤í‚¬ ë´‰ì¸ ì¤‘!'); return; } cd.T=cdMax.T; flash('#7ed9a755',160); toast('ë™ë£Œ ë„ˆêµ¬ë¦¬ ë“±ì¥!', 1000); clearInterval(allyTimer); let allyHits=0; allyTimer=setInterval(()=>{ if(paused) return; const chip= 4+Math.floor(Math.random()*3); enemyHp=Math.max(0, enemyHp-chip); allyHits++; if(allyHits%2===0){ flash('#7ed9a733',90); spark(6); } refreshBars(); if(enemyHp<=0){ clearInterval(allyTimer); winStage(); } },600); setTimeout(()=>{ clearInterval(allyTimer); toast('ë™ë£Œê°€ ì‚¬ë¼ì¡Œë‹¤â€¦', 600); },10000); }

// ===== íë¦„ ì œì–´ =====
function healBetweenStages(){ if(healCapUsed) return; const healAmt = Math.min(30, 100-playerHp); playerHp += Math.min(healAmt, 30); stamina = Math.min(100, stamina+30); healCapUsed=true; }
function startFight(){ rage=0; storyBox.style.display='none'; paused=false; canPunch=true; blocking=false; stunned=false; guardChain=0; guardBroken=false; healCapUsed=false; setStage(stage); startMovement(); enemyPattern(); toast('ë¼ìš´ë“œ ì‹œì‘'); refreshBars(); }
function openStoryForStage(i){ const keys=['s1_pre','s2_pre','s3_pre','s4_pre','s5_pre']; showStory(keys[i]); }
function winStage(){ paused=true; clearInterval(enemyLoop); clearInterval(allyTimer); clearInterval(moveTimer); clearInterval(skillTimer); clearClones(); coins += 10 + State.reward; applyDifficultyScaling(true); healBetweenStages(); if(stage>=STAGES.length-1) return gameOver(true); stage++; setTimeout(()=> openStoryForStage(stage), 300); $stageTxt.textContent=`${stage+1}/5`; $enemyName.textContent=STAGES[stage].name; $name.textContent=STAGES[stage].name; $faceImg.src=STAGES[stage].img; refreshBars(); }
function gameOver(win){ paused=true; clearInterval(enemyLoop); clearInterval(allyTimer); clearInterval(moveTimer); clearInterval(skillTimer); clearClones(); applyDifficultyScaling(false); $center.style.display='grid'; let ending='ì•¼ìƒì˜ ê¸¸ì€ í—˜í–ˆë‹¤.'; if(win){ if(State.legendFlag){ ending='ì „ì„¤ì˜ ë„ˆêµ¬ë¦¬ â€” â€œí’€ìˆ²ì€ ì—¬ì „íˆ ìˆ¨ ì‰°ë‹¤.â€'; } else if(State.altEnding==='truce'){ ending='íƒ€í˜‘ì˜ í‰í™” â€” â€œì£¼ë¨¹ë„, ëˆë„, ì˜¤ëŠ˜ì€ ë‚´ë ¤ë‘ì.â€'; } else { ending='ìŠ¹ìì˜ ê³ ë… â€” â€œë¹„ëŠ” ê³„ì† ë‚´ë ¸ë‹¤.â€'; } }
  $modal.innerHTML = win?`<h1>ëª¨ë“  ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´! ğŸ†</h1><p>${ending}</p><div class="btns"><button class="btn" id="restart">ë‹¤ì‹œ í•˜ê¸°</button></div>`:`<h1>íŒ¨ë°°â€¦</h1><p>${ending}</p><div class="btns"><button class="btn" id="restart">ì¬ë„ì „</button></div>`;
  document.getElementById('restart').onclick=()=>{ stage=0; enemyHp=STAGES[0].hp; playerHp=100; stamina=100; paused=false; canPunch=true; blocking=false; stunned=false; rage=0; coins=0; noDamageStreak=0; for(const k in State){ delete State[k]; } Object.assign(State,{guardBoost:0.5,firstSkillFast:false,onClearHeal:0,enemyEvasion:0.05,enemyFreqScale:1.0,reward:0,guardEmpower:false,startGrace:0,rageCombo:false,legendFlag:false,altEnding:null, atkBonus:0}); setStage(0); $center.style.display='none'; openStoryForStage(0); refreshBars(); };
}

// ===== ì…ë ¥ =====
function focusGame(){ document.body.focus(); }
document.body.addEventListener('keydown', (e)=>{ focusGame(); const k=e.key.toLowerCase(); if(storyBox.style.display==='block'){ if(e.code==='Enter'){ e.preventDefault(); return; } return; }
  if(k==='a'){ doPunch('L'); } else if(k==='d'){ doPunch('R'); } else {
    if(k==='s' || e.code==='Space'){ e.preventDefault(); block(true); }
    if(e.code==='ArrowLeft'){ if(e.shiftKey){ lastDodge=Date.now(); toast('ë‹·ì§€!',260);} else { aimX=Math.max(0.06, aimX-0.04); placeAim(); } }
    if(e.code==='ArrowRight'){ if(e.shiftKey){ lastDodge=Date.now(); toast('ë‹·ì§€!',260);} else { aimX=Math.min(0.94, aimX+0.04); placeAim(); } }
    if(k==='q') skillQ(); if(k==='e') skillE(); if(k==='r') skillR(); if(k==='t') skillT(); if(k==='p'){ paused=!paused; toast(paused?'ì¼ì‹œì •ì§€':'ì¬ê°œ'); }
    if(e.code==='Enter'){ if($center.style.display!=='none'){ $center.style.display='none'; openStoryForStage(0); } }
  }
});
document.body.addEventListener('keyup',(e)=>{ if(e.key.toLowerCase()==='s' || e.code==='Space') block(false); });

// ëª¨ë°”ì¼ ë²„íŠ¼
function aimStep(dir){ aimX=Math.max(0.06, Math.min(0.94, aimX + dir*0.05)); placeAim(); }
document.getElementById('btnAimL').onclick=()=> aimStep(-1);
document.getElementById('btnAimR').onclick=()=> aimStep(1);
document.getElementById('btnL').onclick=()=> doPunch('L');
document.getElementById('btnR').onclick=()=> doPunch('R');
document.getElementById('btnBlk').onpointerdown=()=> block(true);
document.getElementById('btnBlk').onpointerup=()=> block(false);
document.getElementById('btnQ').onclick=()=> skillQ();
document.getElementById('btnE').onclick=()=> skillE();
document.getElementById('btnRk').onclick=()=> skillR();
document.getElementById('btnT').onclick=()=> skillT();

// ì‹œì‘/ë„ì›€
document.getElementById('startBtn').onclick=()=>{ $center.style.display='none'; openStoryForStage(0); };
document.getElementById('howBtn').onclick=()=> toast("A/D=í€ì¹˜, S/Space=ê°€ë“œ, â‡§+â†/â†’=ë‹·ì§€, â†/â†’=ì—ì„, Q/E/R/T=ìŠ¤í‚¬, ! ì§í›„ ì—ì„+í€ì¹˜=ì¹´ìš´í„°",2200);

// ì´ˆê¸°í™”
function initAim(){ placeAim(); }
function initSmoke(){ const rect=$ring.getBoundingClientRect(); smoke.width=rect.width; smoke.height=rect.height; }
setStage(0); refreshBars(); focusGame(); initAim(); initSmoke();
window.addEventListener('resize', ()=>{ placeEnemy(); placeAim(); initSmoke(); });
})();
</script>
</body>
</html>
